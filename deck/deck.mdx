import {
  CodeSurfer,
  CodeSurferColumns,
  Step,
} from "code-surfer";
import { demo, code, deck } from "./theme";
import { Example, Layout } from './layout';

export const theme = deck;

<Layout>

# Remixing Constraint Validation

Remix Conf 2023

</Layout>

---

<Layout>

## What is Constraint Validation?

</Layout>

---

<CodeSurfer theme={code}>

```jsx title="HTML Validation Attributes"


```

```jsx title="HTML Validation Attributes"
<input required />
```

```jsx title="HTML Validation Attributes"
<input required />

<input type="number" min={0} max={5} step={0.5} />

<input type="email" pattern="[^@]+@example.com" />

<textarea minLength={10} maxLength={100}>
```

</CodeSurfer>

---

<Layout>

## Problems

</Layout>

---

<Layout>

## Solutions - DOM APIs

- What is the error
- When to report it

</Layout>

---

<CodeSurfer theme={code}>

```json title="ValidityState"
{
  "badInput": false,
  "customError": false,
  "patternMismatch": false,
  "rangeOverflow": false,
  "rangeUnderflow": false,
  "stepMismatch": false,
  "tooLong": false,
  "tooShort": false,
  "typeMismatch": false,
  "valid": true,
  "valueMissing": false
}
```

```json title="ValidityState" subtitle="if an required input is empty"
{
  "badInput": false,
  "customError": false,
  "patternMismatch": false,
  "rangeOverflow": false,
  "rangeUnderflow": false,
  "stepMismatch": false,
  "tooLong": false,
  "tooShort": false,
  "typeMismatch": false,
  "valid": false,
  "valueMissing": true
}
```
</CodeSurfer>

---

<CodeSurfer theme={code}>

```jsx title="setCustomValidity"
<input
  onChange={event => {
    // The input element
    const input = event.currentTarget;

    if (input.validity.valueMissing) {
      input.setCustomValidity('This field is required');
    } else if (input.validity.typeMismatch) {
      input.setCustomValidity('This field is invalid');
    } else {
      // Reset the error message
      input.setCustomValidity('');
    }

    // To access the error message
    console.log(input.validationMessage);
  }}
/>
```

</CodeSurfer>

---

<CodeSurfer theme={code}>

```jsx title="invalid event" subtitle="By default, the browser will fire an invalid event on submission"
<input
  onInvalid={event => {
    // The invalid form element
    const input = event.currentTarget;

    // The error message:
    console.log(input.validationMessage)

    // Prevent browser error bubble
    event.preventDefault();
  }}
/>
```

```jsx title="reportValidity" subtitle="But you can customize the time when it should fire the invalid event" 
<form
  onSubmit={event => {
    const form = event.currentTarget;

    // By calling reportValidity, the browser will fire
    // the invalid event on all invalid form elements
    if (!form.reportValidity()) {
      // Prevent form submit if there are any errors
      event.preventDefault();
    }
  }}
  noValidate
/>
```

</CodeSurfer>

---

<Layout>

## A Remix Recipe

</Layout>

---

<CodeSurferColumns themes={[demo, code]} sizes={[2,3]}>

<Step>

<Example src="./examples/basic" />

```jsx file=./01.BaseExample.jsx
```

</Step>

<Step subtitle="Reporting error manually with the invalid event">

<Example src="./examples/report-error" />

```jsx file=./02.ReportingErrors.jsx
```

</Step>

<Step subtitle="Clearing messages before reporting new errors">

<Example src="./examples/clear-error" />

```jsx file=./03.ClearingErrors.jsx
```

</Step>

<Step subtitle="Customizing messages based on the ValidityState">

<Example src="./examples/custom-message" />

```jsx file=./04.CustomizingMessage.jsx
```

</Step>

</CodeSurferColumns>

---

<Layout>

# How about the server?

</Layout>

---

<CodeSurferColumns themes={[demo, code]} sizes={[2,3]}>

<Step>

<Example src="./examples/custom-message" />

```jsx 46:66 file=./04.CustomizingMessage.jsx
```

</Step>

<Step subtitle="Extract the constraint of each form control as the schema">

<Example src="./examples/final" />

```jsx 63,72 file=./05.ExtractSchema.jsx
```
</Step>

<Step subtitle="Extract the constraint of each form control as the schema">

<Example src="./examples/final" />

```diff 4:14
```
</Step>

<Step subtitle="The secret sauce">

<Example src="./examples/final" />

```jsx 1 file=./06.CompleteSolution.jsx
```

</Step>

<Step subtitle="Parse formdata based on the schema">

<Example src="./examples/final" />

```diff 31:43
```

</Step>

<Step subtitle="Sync error with the client">

<Example src="./examples/final" />

```diff 46:54
```

</Step>

</CodeSurferColumns>

---

<Layout>

## Progressive Enhancement

</Layout>

---

<Layout>

## Learn more

https://edmund.dev/blog/remixing-constraint-validation

@_edmundhung

</Layout>
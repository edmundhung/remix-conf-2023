import {
  CodeSurfer,
  CodeSurferColumns,
  Step,
} from "code-surfer";
import { demo, code, deck } from "./theme";
import { Example, Layout } from './layout';

export const theme = deck;

<Layout>

# Remixing Constraint Validation

<div styles={{ textAlign: 'right '}}>Edmund Hung @ Remix Conf 2023</div>

</Layout>

---

<Layout>

## A browser mechanism for form validation

<center>#UseThePlatform</center>

</Layout>

---

<CodeSurfer theme={code}>

```jsx title="HTML Validation Attributes"


```

```jsx title="HTML Validation Attributes"
<input required />
```

```jsx title="HTML Validation Attributes"
<input required />

<input type="number" min={0} max={5} step={0.5} />

<input type="email" pattern="[^@]+@example.com" />

<textarea minLength={10} maxLength={100} />
```

</CodeSurfer>

---

<Layout>

## Issues

- Error bubbles look different on each browser
- Styles are not customizable
- Same problems with the error messages
- Report only 1 problem at a time

</Layout>

---

<Layout>

## What we missed: The DOM APIs

</Layout>

---

<CodeSurfer theme={code}>

```jsx title="validationMessage"
<input
  onChange={event => {
    const input = event.currentTarget;

    // Current error message
    console.log(input.validationMessage);

    // ValidityState
    console.log(input.validity);
  }}
/>
```

</CodeSurfer>

---

<CodeSurfer theme={code}>

```json title="ValidityState"
{
  "badInput": false,
  "customError": false,
  "patternMismatch": false,
  "rangeOverflow": false,
  "rangeUnderflow": false,
  "stepMismatch": false,
  "tooLong": false,
  "tooShort": false,
  "typeMismatch": false,
  "valid": true,
  "valueMissing": false
}
```

```json title="ValidityState" subtitle="if a required input is empty"
{
  "badInput": false,
  "customError": false,
  "patternMismatch": false,
  "rangeOverflow": false,
  "rangeUnderflow": false,
  "stepMismatch": false,
  "tooLong": false,
  "tooShort": false,
  "typeMismatch": false,
  "valid": false,
  "valueMissing": true
}
```
</CodeSurfer>

---

<CodeSurfer theme={code}>

```jsx title="invalid event" subtitle="The browser will fire invalid event on submission by default"
<input
  onInvalid={event => {
    // The invalid form element
    const input = event.currentTarget;

    // The error message:
    console.log(input.validationMessage)

    // Prevent browser error bubble
    event.preventDefault();
  }}
/>
```

</CodeSurfer>

---

<CodeSurfer theme={code}>

```jsx title="reportValidity" subtitle="Customize when the browser should fire invalid event" 
<form
  onSubmit={event => {
    const form = event.currentTarget;

    // By calling reportValidity, the browser will fire
    // the invalid event on all invalid form elements
    if (!form.reportValidity()) {
      // Prevent form submit if there are any errors
      event.preventDefault();
    }
  }}
  noValidate
/>
```

</CodeSurfer>

---

<Layout>

## A Remix Recipe üßë‚Äçüç≥

</Layout>

---

<CodeSurferColumns themes={[demo, code]} sizes={[2,3]}>

<Step>

<Example src="./examples/basic" />

```jsx file=./01.BaseExample.jsx
```

</Step>

<Step subtitle="Reporting error manually with the invalid event">

<Example src="./examples/report-error" />

```jsx 10,21 file=./02.ReportingErrors.jsx
```

</Step>

<Step subtitle="Clearing messages before reporting new errors">

<Example src="./examples/clear-error" />

```jsx file=./03.ClearingErrors.jsx
```

</Step>

<Step subtitle="Customizing messages based on the ValidityState">

<Example src="./examples/custom-message" />

```jsx file=./04.CustomizingMessage.jsx
```

</Step>

</CodeSurferColumns>

---

<Layout>

## How about the server?

</Layout>

---

<Layout>

## The secret sauce üî•: @conform-to/validitystate

- A package for you to validate on the server based on the ValidityState 
- Type inference support
- 0kb on the client. You need it only on the server

</Layout>

---

<CodeSurferColumns themes={[demo, code]} sizes={[2,3]}>

<Step>

<Example src="./examples/custom-message" />

```jsx 46:66 file=./04.CustomizingMessage.jsx
```

</Step>

<Step subtitle="Extract the constraint of each form control as the schema">

<Example src="./examples/final" />

```jsx 63,72 file=./05.ExtractSchema.jsx
```
</Step>

<Step subtitle="Extract the constraint of each form control as the schema">

<Example src="./examples/final" />

```diff 4:14
```
</Step>

<Step subtitle="Import the parse helper">

<Example src="./examples/final" />

```jsx 1 file=./06.CompleteSolution.jsx
```

</Step>

<Step subtitle="Parse formData based on the schema">

<Example src="./examples/final" />

```jsx 31:43 file=./06.CompleteSolution.jsx
```

</Step>

<Step subtitle="Sync error with the client">

<Example src="./examples/final" />

```diff 46:54
```

</Step>

</CodeSurferColumns>

---

<Layout>

## Learn more

https://edmund.dev/blog/remixing-constraint-validation

@_edmundhung

</Layout>